require("dotenv").config();
const { initializeApp, cert } = require("firebase-admin/app");
const { getFirestore } = require("firebase-admin/firestore");
const { calcularHorasTrabalhadas } = require("../utils/timeUtils");

// Configura√ß√£o do Firebase seguindo o padr√£o do seu projeto
const serviceAccount = {
  type: "service_account",
  project_id: process.env.FIREBASE_PROJECT_ID,
  private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
  private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, "\n"),
  client_email: process.env.FIREBASE_CLIENT_EMAIL,
  client_id: process.env.FIREBASE_CLIENT_ID,
  auth_uri: "https://accounts.google.com/o/oauth2/auth",
  token_uri: "https://oauth2.googleapis.com/token",
  auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
  client_x509_cert_url: process.env.FIREBASE_CLIENT_CERT_URL,
  universe_domain: "googleapis.com",
};

// Inicializar Firebase
initializeApp({
  credential: cert(serviceAccount),
});

const db = getFirestore();

// Mapeamento de displayNames para IDs do Discord
const userIds = {
  'Gustavo Haschich': '252950537559998471',
  'Cleverson': '663798051382493212',
  'Thiago Foltran': '1031897347849981952',
  'Vinicius Grzyb': '1085617322250752041',
  'Feliphe': '1148268621655703662',
  'Carlos Henrique': '1171796385008455745',
  'Iza': '1197244152837058575',
  'Wellington Moscon - GoEpik': '689550618117144645',
  'Luan Drulla': '1126951391244603472',
  'Jonathan Villa√ßa': '1402283024577466441',
  'Diogo Haschich': '1344074391608098868'
};

const timesheetData = {
  '2025-08-25': {
    'Vinicius Grzyb': { entrada: '08:14', saida: '17:35' },
    'Cleverson': { entrada: '08:28', saida: '17:30' },
    'Luan Drulla': { entrada: '08:45', saida: '17:46' },
    'Gustavo Haschich': { entrada: '08:17', saida: '17:43' },
    'Feliphe': { entrada: '08:30', saida: '17:55' },
    'Carlos Henrique': { entrada: '08:54', saida: '17:55' },
    'Wellington Moscon - GoEpik': { entrada: '09:03', saida: '18:40' },
    'Diogo Haschich': { entrada: '13:58', saida: '19:29' },
  },
  '2025-08-26': {
    'Vinicius Grzyb': { entrada: '08:30', saida: '17:40' },
    'Cleverson': { entrada: '08:13', saida: '16:46' },
    'Luan Drulla': { entrada: '08:44', saida: '17:00' },
    'Gustavo Haschich': { entrada: '08:21', saida: '18:01' },
    'Feliphe': { entrada: '08:23', saida: '17:34' },
    'Carlos Henrique': { entrada: '09:01', saida: '17:46' },
    'Iza': { entrada: '07:53', saida: '16:08' },
    'Wellington Moscon - GoEpik': { entrada: '08:47', saida: '18:24' },
    'Diogo Haschich': { entrada: '13:58', saida: '18:01' },
  },
  '2025-08-27': {
    'Vinicius Grzyb': { entrada: '08:14', saida: '17:38' },
    'Cleverson': { entrada: '08:23', saida: '17:24' },
    'Luan Drulla': { entrada: '08:31', saida: '18:00' },
    'Gustavo Haschich': { entrada: '08:26', saida: '17:54' },
    'Feliphe': { entrada: '08:46', saida: '17:50' },
    'Carlos Henrique': { entrada: '08:55', saida: '17:56' },
    'Iza': { entrada: '07:45', saida: '16:00' },
    'Wellington Moscon - GoEpik': { entrada: '08:59', saida: '19:18' },
    'Diogo Haschich': { entrada: '14:00', saida: '18:59' },
  },
  '2025-08-28': {
    'Vinicius Grzyb': { entrada: '08:17', saida: '18:12' },
    'Cleverson': { entrada: '08:10', saida: '17:17' },
    'Luan Drulla': { entrada: '08:56', saida: '18:11' },
    'Gustavo Haschich': { entrada: '08:08', saida: '18:41' },
    'Feliphe': { entrada: '08:31', saida: '17:43' },
    'Carlos Henrique': { entrada: '08:53', saida: '17:53' },
    'Iza': { entrada: '07:55', saida: '16:30' },
    'Wellington Moscon - GoEpik': { entrada: '08:53', saida: '18:00' },
    'Diogo Haschich': { entrada: '13:58', saida: '19:00' },
  },
  '2025-08-29': {
    'Vinicius Grzyb': { entrada: '08:20', saida: '18:55' },
    'Cleverson': { entrada: '07:52', saida: '17:08' },
    'Luan Drulla': { entrada: '08:45', saida: '19:04' },
    'Gustavo Haschich': { entrada: '07:43', saida: '18:10' },
    'Feliphe': { entrada: '08:32', saida: '17:33' },
    'Carlos Henrique': { entrada: '08:55', saida: '17:56' },
    'Iza': { entrada: '08:00', saida: '16:16' },
    'Wellington Moscon - GoEpik': { entrada: '09:18', saida: '19:06' },
    'Diogo Haschich': { entrada: '13:59', saida: '19:01' },
  },
  '2025-08-30': {
    'Vinicius Grzyb': { entrada: '14:30', saida: '16:27' },
  },
};

// Fun√ß√£o para calcular horas trabalhadas usando a mesma l√≥gica do seu sistema
function calcularHorasTrabalhadasCustom(entrada, saida, dataFormatada) {
  const dataCompletaEntrada = `${dataFormatada}T${entrada}:00`;
  const dataCompletaSaida = `${dataFormatada}T${saida}:00`;

  // Simular 1 hora de pausa (conforme especificado)
  const pausaAlmoco = [
    {
      inicio: `${dataFormatada}T12:00:00`,
      fim: `${dataFormatada}T13:00:00`
    }
  ];

  const { totalHoras, totalPausas } = calcularHorasTrabalhadas(
    dataCompletaEntrada,
    dataCompletaSaida,
    pausaAlmoco
  );

  return { totalHoras, totalPausas };
}

// Fun√ß√£o principal para inserir os dados seguindo o padr√£o do seu sistema
async function inserirDadosPonto() {
  try {
    console.log('üöÄ Iniciando inser√ß√£o dos dados de ponto...');
    console.log('üìã Seguindo estrutura da collection "registros"');
    console.log('üóìÔ∏è  Per√≠odo: 01/08/2025 a 21/08/2025');
    console.log('üë• Incluindo: Jonathan Villa√ßa, Diogo Haschich');
    console.log('üëã √öltimo dia do Thiago: 14/08/2025');
    console.log('üìù Formato do documento: displayName_YYYY-MM-DD\n');

    let totalInseridos = 0;

    for (const [data, usuarios] of Object.entries(timesheetData)) {
      console.log(`üìÖ Processando data: ${data}`);

      for (const [displayName, horarios] of Object.entries(usuarios)) {
        const discordId = userIds[displayName];

        if (!discordId) {
          console.log(`‚ö†Ô∏è  Discord ID n√£o encontrado para: ${displayName}`);
          continue;
        }

        // Calcular horas trabalhadas usando sua fun√ß√£o
        const { totalHoras, totalPausas } = calcularHorasTrabalhadasCustom(
          horarios.entrada,
          horarios.saida,
          data
        );

        // Criar ID do documento no padr√£o: 'displayName_YYYY-MM-DD'
        const documentId = `${displayName}_${data}`;

        // Estrutura de dados seguindo exatamente o padr√£o do seu sistema
        const dadosRegistro = {
          usuario: displayName,
          data: data,
          entrada: horarios.entrada,
          saida: horarios.saida,
          total_horas: totalHoras,
          total_pausas: totalPausas,
          discordId: discordId,
          pausas: [
            {
              inicio: `${data}T12:00:00.000Z`,
              fim: `${data}T13:00:00.000Z`
            }
          ],
          manual: false,
          createdAt: new Date().toISOString()
        };

        // Inserir no Firebase na collection "registros"
        const docRef = db.collection('registros').doc(documentId);
        await docRef.set(dadosRegistro);

        console.log(`‚úÖ ${displayName}: ${horarios.entrada} ‚Üí ${horarios.saida} = ${totalHoras} (ID: ${discordId})`);
        totalInseridos++;
      }

      console.log(''); // Linha em branco
    }

    console.log(`üéâ Inser√ß√£o conclu√≠da! Total de registros inseridos: ${totalInseridos}`);
    console.log('üìä Os registros seguem a estrutura padr√£o da collection "registros"');
    console.log('üë§ Formato do documento: displayName_YYYY-MM-DD');
    console.log('üìÖ Per√≠odo processado: 01/08/2025 a 21/08/2025');
    console.log('üÜï Novos usu√°rios: Jonathan Villa√ßa e Diogo Haschich');
    console.log('üëã Thiago Foltran - √∫ltimo registro: 14/08/2025');

  } catch (error) {
    console.error('‚ùå Erro ao inserir dados:', error);
    process.exit(1);
  }
}

// Fun√ß√£o para verificar os dados antes de inserir
function verificarDados() {
  console.log('=== üîç VERIFICA√á√ÉO DOS DADOS ===\n');
  console.log('üóìÔ∏è  Per√≠odo: 01/08/2025 a 21/08/2025');
  console.log('üë§ Formato do documento: displayName_YYYY-MM-DD');
  console.log('üÜï Novos usu√°rios: Jonathan Villa√ßa e Diogo Haschich');
  console.log('üëã Thiago Foltran sai em 14/08/2025\n');

  let totalRegistros = 0;
  const resumoPorDia = {};

  for (const [data, usuarios] of Object.entries(timesheetData)) {
    console.log(`üìÖ Data: ${data}`);
    resumoPorDia[data] = Object.keys(usuarios).length;

    for (const [displayName, horarios] of Object.entries(usuarios)) {
      const discordId = userIds[displayName];
      const documentId = `${displayName}_${data}`;

      if (!discordId) {
        console.log(`  ‚ùå ${displayName} - Discord ID n√£o encontrado!`);
        continue;
      }

      const { totalHoras, totalPausas } = calcularHorasTrabalhadasCustom(
        horarios.entrada,
        horarios.saida,
        data
      );

      console.log(`  üë§ ${displayName}`);
      console.log(`     Discord ID: ${discordId}`);
      console.log(`     Doc ID: ${documentId}`);
      console.log(`     Entrada: ${horarios.entrada}`);
      console.log(`     Sa√≠da: ${horarios.saida}`);
      console.log(`     Horas trabalhadas: ${totalHoras}`);
      console.log(`     Total pausas: ${totalPausas}`);
      console.log('');

      totalRegistros++;
    }
  }

  console.log(`üìä RESUMO GERAL:`);
  console.log(`   Total de registros: ${totalRegistros}`);
  console.log(`   Dias processados: ${Object.keys(timesheetData).length}`);
  console.log(`   Registros por dia:`);

  for (const [data, quantidade] of Object.entries(resumoPorDia)) {
    console.log(`     ${data}: ${quantidade} pessoas`);
  }

  console.log('\nüèóÔ∏è  Estrutura seguir√° o padr√£o da collection "registros"');
  console.log('‚è∞ Cada registro ter√° 1 hora de pausa simulada (12:00-13:00)');
  console.log('üë§ Usando displayName para campo "usuario" e ID do documento\n');
}

// Fun√ß√£o para verificar se j√° existem registros
async function verificarRegistrosExistentes() {
  console.log('üîç Verificando registros existentes para agosto de 2025...\n');

  let encontrados = 0;

  for (const [data, usuarios] of Object.entries(timesheetData)) {
    console.log(`üìÖ Verificando ${data}:`);
    for (const [displayName] of Object.entries(usuarios)) {
      const documentId = `${displayName}_${data}`;
      const docRef = db.collection('registros').doc(documentId);
      const doc = await docRef.get();

      if (doc.exists) {
        console.log(`  ‚ö†Ô∏è  EXISTE: ${documentId}`);
        const dados = doc.data();
        console.log(`     Entrada atual: ${dados.entrada || 'N/A'}`);
        console.log(`     Sa√≠da atual: ${dados.saida || 'N/A'}`);
        console.log(`     Total horas: ${dados.total_horas || 'N/A'}`);
        encontrados++;
      } else {
        console.log(`  ‚úÖ Livre: ${documentId}`);
      }
    }
    console.log('');
  }

  if (encontrados === 0) {
    console.log('‚úÖ Nenhum registro encontrado para o per√≠odo. Seguro para inserir!');
  } else {
    console.log(`‚ö†Ô∏è  Encontrados ${encontrados} registros existentes. Verifique antes de inserir!`);
  }
}

// Fun√ß√£o para executar com confirma√ß√£o autom√°tica
async function executarComConfirmacao() {
  console.log('üîß Sistema de Ponto - Inser√ß√£o de Dados Hist√≥ricos');
  console.log('üìÇ Collection: registros');
  console.log('üóìÔ∏è  Per√≠odo: 01/08/2025 a 21/08/2025');
  console.log('üë§ Formato: displayName_YYYY-MM-DD');
  console.log('üÜï Novos usu√°rios: Jonathan Villa√ßa e Diogo Haschich\n');

  // Verificar os dados primeiro
  verificarDados();

  console.log('‚ö†Ô∏è  ATEN√á√ÉO: Este script ir√° inserir dados na collection "registros"');
  console.log('üìù Certifique-se de que n√£o existem registros duplicados para essas datas\n');

  // Aguardar 3 segundos e executar automaticamente
  console.log('üöÄ Iniciando inser√ß√£o em 3 segundos...');
  await new Promise(resolve => setTimeout(resolve, 3000));

  await inserirDadosPonto();
  process.exit(0);
}

// Fun√ß√£o padr√£o para visualiza√ß√£o
async function executar() {
  console.log('üîß Sistema de Ponto - Inser√ß√£o de Dados Hist√≥ricos');
  console.log('üìÇ Collection: registros');
  console.log('üóìÔ∏è  Per√≠odo: 06/08/2025 a 21/08/2025');
  console.log('üë§ Formato: displayName_YYYY-MM-DD');
  console.log('üÜï Novos usu√°rios: Jonathan Villa√ßa e Diogo Haschich\n');

  // Verificar os dados primeiro
  verificarDados();

  console.log('‚ö†Ô∏è  ATEN√á√ÉO: Este script ir√° inserir dados na collection "registros"');
  console.log('üìù Certifique-se de que n√£o existem registros duplicados para essas datas');
  console.log('');
  console.log('üí° Para executar imediatamente: node script.js --execute');
  console.log('üîç Para verificar registros existentes: node script.js --check-existing');
  console.log('üö´ Para cancelar, pressione Ctrl+C');
}

// Exportar fun√ß√µes
module.exports = {
  inserirDadosPonto,
  verificarDados,
  executar,
  verificarRegistrosExistentes
};

// Executar automaticamente se o script for chamado diretamente
if (require.main === module) {
  const args = process.argv.slice(2);

  if (args.includes('--execute') || args.includes('-e')) {
    executarComConfirmacao().catch(console.error);
  } else if (args.includes('--check-existing')) {
    verificarRegistrosExistentes().catch(console.error);
  } else {
    executar().catch(console.error);
  }
}